{% extends 'base.html' %}

{% block title %}Lista de Pacientes - MakiMotion{% endblock %}

{% block content %}
<div class="patient-list-container">
    <div class="patient-list-header">
        <h2>📋 Todos los Pacientes</h2>
        <p class="subtitle">Total de pacientes: {{ total_patients }}</p>
    </div>
    
    <div class="patient-list-controls">
        <form method="get" class="search-form" id="patient-search-form">
            <div class="search-input-group">
                <input id="patient-search-input" type="text" name="q" value="{{ query }}" 
                       placeholder="Buscar paciente por nombre..." class="search-input">
                <button type="submit" class="search-btn">🔍</button>
            </div>
        </form>
        
        <a href="{% url 'patient_create' %}" class="btn btn-primary">
            ➕ Nuevo Paciente
        </a>
    </div>

    <div class="patients-table-container">
        {% if patients %}
            <table class="patients-table">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Edad</th>
                        <th>Profesión</th>
                        <th>Estado</th>
                        <th>Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in patients %}
                    <tr class="patient-row {% if patient.alta %}patient-discharged{% else %}patient-active{% endif %}">
                        <td class="patient-name">
                            <strong>{{ patient.full_name }}</strong>
                        </td>
                        <td class="patient-age">
                            <span class="age-badge">{{ patient.age }} años</span>
                        </td>
                        <td class="patient-profession">
                            {{ patient.profession|default:"No especificada" }}
                        </td>
                        <td class="patient-status">
                            {% if patient.alta %}
                                <span class="status-badge status-discharged">Alta</span>
                            {% else %}
                                <span class="status-badge status-active">Activo</span>
                            {% endif %}
                        </td>
                        <td class="patient-created">
                            {{ patient.created_at|date:"d/m/Y" }}
                        </td>
                        <td class="patient-actions">
                            <div class="action-buttons">
                                <a href="{% url 'patient_detail' patient.pk %}" 
                                   class="action-btn btn-view" title="Ver detalles">
                                    👁️
                                </a>
                                <a href="{% url 'patient_update' patient.pk %}" 
                                   class="action-btn btn-edit" title="Editar">
                                    ✏️
                                </a>
                                <a href="{% url 'patient_delete' patient.pk %}" 
                                   class="action-btn btn-delete" title="Eliminar">
                                    🗑️
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">👥</div>
                <h3>No hay pacientes</h3>
                <p>{% if query %}No se encontraron pacientes que coincidan con "{{ query }}"{% else %}Aún no has registrado ningún paciente{% endif %}</p>
                {% if not query %}
                    <a href="{% url 'patient_create' %}" class="btn btn-primary">Crear primer paciente</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
(function(){
    const input = document.getElementById('patient-search-input');
    const form = document.getElementById('patient-search-form');
    let timer = null;
    const debounce = (fn, wait) => {
        return function(...args){
            clearTimeout(timer);
            timer = setTimeout(()=> fn.apply(this, args), wait);
        }
    };

    const handleInput = () => {
        const val = input.value.trim();
        // Enviar si tiene 2 o más caracteres, o si quedó vacío (reset)
        if (val.length >= 2 || val.length === 0) {
            form.submit();
        }
        // si tiene 1 carácter, no hacer nada (evita consultas innecesarias)
    };

    input.addEventListener('input', debounce(handleInput, 300));
})();
</script>
{% endblock %}

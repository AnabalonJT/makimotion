{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar Paciente {% else %}Nuevo Paciente{% endif %} - MakiMotion
{% endblock %}

{% block content %}
<div class="clinical-form-container">
    <div class="form-header">
        <h2>
            {% if form.instance.pk %}
                Editar Paciente: {{ form.instance.full_name }}
            {% else %}
                Nuevo Paciente
            {% endif %}
        </h2>
        <p class="form-subtitle">
            {% if form.instance.pk %}
                Actualiza la informaci칩n de la ficha cl칤nica
            {% else %}
                Completa los datos de la ficha cl칤nica del paciente
            {% endif %}
        </p>
    </div>
    
    {% if form.errors %}
        <div class="alert alert-error">
            <strong>Por favor corrige los siguientes errores:</strong>
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    <form method="post" class="clinical-form" id="patient-form">
        {% csrf_token %}

        
        
        <!-- SECCI칍N 1: DATOS DEL PACIENTE -->
        <div class="form-section">
            <h3 class="section-title">游늶 Datos del Paciente</h3>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.full_name.id_for_label }}">Nombre Completo *</label>
                        {{ form.full_name }}
                        {% if form.full_name.errors %}<span class="field-error">{{ form.full_name.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.birth_date.id_for_label }}">Fecha de Nacimiento *</label>
                        {{ form.birth_date }}
                        {% if form.birth_date.errors %}<span class="field-error">{{ form.birth_date.errors.0 }}</span>{% endif %}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.profession.id_for_label }}">Profesi칩n</label>
                        {{ form.profession }}
                        {% if form.profession.errors %}<span class="field-error">{{ form.profession.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.phone.id_for_label }}">Tel칠fono</label>
                        {{ form.phone }}
                        {% if form.phone.errors %}<span class="field-error">{{ form.phone.errors.0 }}</span>{% endif %}
                    </div>
                </div>
                <div class="form-group">
                    <label for="{{ form.address.id_for_label }}">Direcci칩n</label>
                    {{ form.address }}
                    {% if form.address.errors %}<span class="field-error">{{ form.address.errors.0 }}</span>{% endif %}
                </div>
                <!-- SECCI칍N: ESTADO (alta) -->
   
                <h3 class="section-title">Estado</h3>
                <div class="section-content">
                    <div class="form-group">
                        <div class="checkbox-item">
                            {{ form.alta }} <label for="{{ form.alta.id_for_label }}">Paciente dado de alta</label>
                            {% if form.alta.errors %}<span class="field-error">{{ form.alta.errors.0 }}</span>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Embarazo -->
                <div class="subsection-group">
                    <h4>Embarazo</h4>
                    <div class="checkbox-item">
                        {{ form.is_pregnant }} <label for="{{ form.is_pregnant.id_for_label }}">쮼st치 embarazada?</label>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.pregnancy_weeks_at_registration.id_for_label }}">Semanas de Embarazo Actuales</label>
                            {{ form.pregnancy_weeks_at_registration }}
                            {% if form.pregnancy_weeks_at_registration.errors %}<span class="field-error">{{ form.pregnancy_weeks_at_registration.errors.0 }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.pregnancy_week_day.id_for_label }}">D칤a de la Semana para Contar</label>
                            {{ form.pregnancy_week_day }}
                            {% if form.pregnancy_week_day.errors %}<span class="field-error">{{ form.pregnancy_week_day.errors.0 }}</span>{% endif %}
                        </div>
                    </div>
                    <small class="text-muted">Las semanas se actualizar치n autom치ticamente cada {{ form.pregnancy_week_day.value|default:"d칤a seleccionado" }}</small>
                </div>

                <!-- Postparto -->
                <div class="subsection-group">
                    <h4>Postparto</h4>
                    <div class="checkbox-item">
                        {{ form.is_postpartum }} <label for="{{ form.is_postpartum.id_for_label }}">쮼st치 en postparto?</label>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="{{ form.postpartum_weeks_at_registration.id_for_label }}">Semanas de Postparto Actuales</label>
                            {{ form.postpartum_weeks_at_registration }}
                            {% if form.postpartum_weeks_at_registration.errors %}<span class="field-error">{{ form.postpartum_weeks_at_registration.errors.0 }}</span>{% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.postpartum_week_day.id_for_label }}">D칤a de la Semana para Contar</label>
                            {{ form.postpartum_week_day }}
                            {% if form.postpartum_week_day.errors %}<span class="field-error">{{ form.postpartum_week_day.errors.0 }}</span>{% endif %}
                        </div>
                    </div>
                    <small class="text-muted">Las semanas se actualizar치n autom치ticamente cada {{ form.postpartum_week_day.value|default:"d칤a seleccionado" }}</small>
                </div>

        <script>
        // Mostrar/ocultar aprendizajes embarazo seg칰n el checkbox
        document.addEventListener('DOMContentLoaded', function() {
            var embarazoCheckbox = document.getElementById('{{ form.is_pregnant.id_for_label }}');
            var embarazoSection = document.getElementById('aprendizajes-embarazo-section');
            function toggleEmbarazoSection() {
                if (embarazoCheckbox && embarazoCheckbox.checked) {
                    embarazoSection.style.display = '';
                } else {
                    embarazoSection.style.display = 'none';
                }
            }
            if (embarazoCheckbox && embarazoSection) {
                embarazoCheckbox.addEventListener('change', toggleEmbarazoSection);
                toggleEmbarazoSection();
            }
            
            // Funcionalidad para postparto (mostrar/ocultar campos)
            var postpartoCheckbox = document.getElementById('{{ form.is_postpartum.id_for_label }}');
            var postpartoFields = postpartoCheckbox ? postpartoCheckbox.closest('.subsection-group').querySelectorAll('.form-row, small') : null;
            
            function togglePostpartoFields() {
                if (postpartoFields) {
                    postpartoFields.forEach(function(field) {
                        if (postpartoCheckbox.checked) {
                            field.style.display = '';
                        } else {
                            field.style.display = 'none';
                        }
                    });
                }
            }
            
            if (postpartoCheckbox) {
                postpartoCheckbox.addEventListener('change', togglePostpartoFields);
                togglePostpartoFields(); // Ejecutar al cargar la p치gina
            }
        });
        </script>
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.medications.id_for_label }}">Medicamentos</label>
                        {{ form.medications }}
                        {% if form.medications.errors %}<span class="field-error">{{ form.medications.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.musculoskeletal_history.id_for_label }}">Antecedentes M칰sculo Esquel칠tico</label>
                        {{ form.musculoskeletal_history }}
                        {% if form.musculoskeletal_history.errors %}<span class="field-error">{{ form.musculoskeletal_history.errors.0 }}</span>{% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="{{ form.patient_data_other.id_for_label }}">Otros</label>
                    {{ form.patient_data_other }}
                     {% if form.patient_data_other.errors %}<span class="field-error">{{ form.patient_data_other.errors.0 }}</span>{% endif %}
                </div>
            </div>
        </div>



        <!-- SECCI칍N 2: ANTECEDENTES GINECOL칍GICOS -->
        <div class="form-section">
            <h3 class="section-title">游뽘 Antecedentes Ginecol칩gicos</h3>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.menopause.id_for_label }}">Menopausia</label>
                        {{ form.menopause }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.menopause_time.id_for_label }}">Hace Cu치nto</label>
                        {{ form.menopause_time }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.regular_menstrual_cycle.id_for_label }}">Ciclo Menstrual Regular</label>
                        {{ form.regular_menstrual_cycle }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.pregnancies_g.id_for_label }}">G (Gestaciones)</label>
                        {{ form.pregnancies_g }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.abortions_a.id_for_label }}">A (Abortos)</label>
                        {{ form.abortions_a }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.losses_p.id_for_label }}">P (P칠rdidas)</label>
                        {{ form.losses_p }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.child_weight.id_for_label }}">Peso del Hijo</label>
                        {{ form.child_weight }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.delivery_type.id_for_label }}">Tipo de Parto</label>
                        {{ form.delivery_type }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.episiotomies.id_for_label }}">Episiotom칤as</label>
                        {{ form.episiotomies }}
                    </div>
                </div>
                
                <!-- Checkboxes ginecol칩gicos -->
                <div class="checkbox-group">
                    <h4>Indicadores</h4>
                    <div class="checkbox-row">
                        <div class="checkbox-item">
                            {{ form.io }} <label for="{{ form.io.id_for_label }}">IO</label>
                        </div>
                        <div class="checkbox-item">
                            {{ form.if_field }} <label for="{{ form.if_field.id_for_label }}">IF</label>
                        </div>
                        <div class="checkbox-item">
                            {{ form.ig }} <label for="{{ form.ig.id_for_label }}">IG</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.prolapse.id_for_label }}">Prolapso</label>
                        {{ form.prolapse }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.prolapse_type.id_for_label }}">쮺u치l Prolapso?</label>
                        {{ form.prolapse_type }}
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.allergies.id_for_label }}">Alergias</label>
                    {{ form.allergies }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.gynecological_other.id_for_label }}">Otros</label>
                    {{ form.gynecological_other }}
                </div>
            </div>
        </div>

        <!-- BOTONES DE ACCI칍N NORMALES (para m칩viles) -->
        

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if form.instance.pk %}Actualizar Ficha Cl칤nica{% else %}Crear Ficha Cl칤nica{% endif %}
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<!-- BOTONES DE ACCI칍N FLOTANTES (fuera del contenedor) -->
<div class="floating-actions">
    <button type="submit" form="patient-form" class="btn btn-primary btn-floating">
        {% if form.instance.pk %}Actualizar{% else %}Crear{% endif %}
    </button>
    <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-floating">Cancelar</a>
</div>

{% endblock %}
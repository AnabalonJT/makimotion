{% extends 'base.html' %}

{% block title %}{{ patient.full_name }} - Ficha Clínica - MakiMotion{% endblock %}

{% block content %}
<div class="clinical-detail-container">
    <div class="patient-header">
        <div class="patient-info">
            <h2>{{ patient.full_name }}</h2>
            <div class="patient-meta">
                <span class="patient-age">{{ patient.age }} años</span>
                <span class="patient-profession">{{ patient.profession|default:"Sin profesión" }}</span>
                <span class="patient-created">Registrado: {{ patient.created_at|date:"d/m/Y" }}</span>
            </div>
            {% if patient.consultation_reason %}
            <div class="patient-consultation-reason">
                <strong>Motivo de consulta:</strong> {{ patient.consultation_reason }}
            </div>
            {% endif %}
        </div>
        <div class="patient-actions">
            <a href="{% url 'patient_update' patient.pk %}" class="btn btn-primary">Editar Paciente</a>
            <a href="{% url 'patient_delete' patient.pk %}" class="btn btn-danger">Eliminar</a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Volver al Dashboard</a>
            {% if not patient.alta %}
                <form method="post" action="{% url 'patient_update' patient.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="alta" value="true">
                    <button type="submit" class="btn btn-success">Dar de Alta</button>
                </form>
            {% else %}
                <span class="badge bg-success ms-2">Paciente dado de alta</span>
            {% endif %}
        </div>
    </div>

    <div class="patient-content-layout">
        <div class="main-content-column">
            <!-- SECCIÓN 1: DATOS DEL PACIENTE -->
            <div class="clinical-section">
                <h3 class="section-title">📋 Datos del Paciente</h3>
                <div class="section-content">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nombre Completo:</strong>
                                <span>{{ patient.full_name }}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Edad:</strong>
                                <span>{{ patient.age }} años</span>
                            </div>
                            <div class="detail-item">
                                <strong>Profesión:</strong>
                                <span>{{ patient.profession|default:"No especificada" }}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Teléfono:</strong>
                                <span>{{ patient.phone|default:"No especificado" }}</span>
                            </div>
                        </div>

                        {% if patient.address %}
                            <div class="detail-item full-width">
                                <strong>Dirección:</strong>
                                <span>{{ patient.address }}</span>
                            </div>
                        {% endif %}

                        {% if patient.consultation_reason %}
                            <div class="detail-item full-width">
                                <strong>Motivo de Consulta:</strong>
                                <span>{{ patient.consultation_reason|linebreaks }}</span>
                            </div>
                        {% endif %}

                        {% if patient.medications %}
                            <div class="detail-item full-width">
                                <strong>Medicamentos:</strong>
                                <span>{{ patient.medications|linebreaks }}</span>
                            </div>
                        {% endif %}

                        {% if patient.musculoskeletal_history %}
                            <div class="detail-item full-width">
                                <strong>Antecedentes Músculo Esquelético:</strong>
                                <span>{{ patient.musculoskeletal_history|linebreaks }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- SECCIÓN: APRENDIZAJES GENERALES -->
                <div class="clinical-section">
                    <h3 class="section-title">🧠 Aprendizajes Generales</h3>
                    <div class="section-content">
                        <div class="detail-grid">
                            {% if patient.aprendizaje_pujo_caca %}<div class="detail-item"><span>✔️ Pujo caca</span></div>{% endif %}
                            {% if patient.aprendizaje_banquito %}<div class="detail-item"><span>✔️ Uso de banquito</span></div>{% endif %}
                            {% if patient.aprendizaje_transverso %}<div class="detail-item"><span>✔️ Activación transverso abdominal</span></div>{% endif %}
                            {% if patient.aprendizaje_respiracion_pelvico %}<div class="detail-item"><span>✔️ Respiración + contracción piso pélvico</span></div>{% endif %}
                            {% if patient.aprendizaje_contraccion_pelvico %}<div class="detail-item"><span>✔️ Contracción piso pélvico</span></div>{% endif %}
                            {% if patient.aprendizaje_preapretar %}<div class="detail-item"><span>✔️ Preapretar</span></div>{% endif %}
                        </div>
                        {% if patient.aprendizaje_otros %}
                            <div class="detail-item full-width">
                                <strong>Otros aprendizajes generales:</strong>
                                <span>{{ patient.aprendizaje_otros|linebreaks }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- SECCIÓN: APRENDIZAJES EMBARAZO (solo si está embarazada o tiene aprendizajes) -->
                {% if patient.is_pregnant or patient.aprendizaje_emb_oms or patient.aprendizaje_emb_anatomia or patient.aprendizaje_emb_movimientos or patient.aprendizaje_emb_posicion_trabajo or patient.aprendizaje_emb_posicion_expulsion or patient.aprendizaje_emb_intervencion or patient.aprendizaje_emb_masaje_perineal or patient.aprendizaje_emb_respiraciones or patient.aprendizaje_emb_pujo or patient.aprendizaje_emb_tecnicas_dolor or patient.aprendizaje_emb_otros %}
                <div class="clinical-section">
                    <h3 class="section-title">🤰 Aprendizajes Embarazo</h3>
                    <div class="section-content">
                        <div class="detail-grid">
                            {% if patient.aprendizaje_emb_oms %}<div class="detail-item"><span>✔️ OMS</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_anatomia %}<div class="detail-item"><span>✔️ Anatomía</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_movimientos %}<div class="detail-item"><span>✔️ Movimientos cardinales</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_posicion_trabajo %}<div class="detail-item"><span>✔️ Posición trabajo de parto</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_posicion_expulsion %}<div class="detail-item"><span>✔️ Posición expulsión</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_intervencion %}<div class="detail-item"><span>✔️ Intervención obstétrica</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_masaje_perineal %}<div class="detail-item"><span>✔️ Masaje perineal</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_respiraciones %}<div class="detail-item"><span>✔️ Respiraciones</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_pujo %}<div class="detail-item"><span>✔️ Pujo embarazo</span></div>{% endif %}
                            {% if patient.aprendizaje_emb_tecnicas_dolor %}<div class="detail-item"><span>✔️ Técnicas de dolor</span></div>{% endif %}
                        </div>
                        {% if patient.aprendizaje_emb_otros %}
                            <div class="detail-item full-width">
                                <strong>Otros aprendizajes embarazo:</strong>
                                <span>{{ patient.aprendizaje_emb_otros|linebreaks }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

        <!-- SECCIÓN 2: ANTECEDENTES GINECOLÓGICOS -->
        <div class="clinical-section">
            <h3 class="section-title">🩺 Antecedentes Ginecológicos</h3>
            <div class="section-content">
                <div class="detail-grid">
                    {% if patient.menopause %}
                        <div class="detail-item">
                            <strong>Menopausia:</strong>
                            <span>{{ patient.get_menopause_display }}{% if patient.menopause_time %} ({{ patient.menopause_time }}){% endif %}</span>
                        </div>
                    {% endif %}

                    {% if patient.regular_menstrual_cycle %}
                        <div class="detail-item">
                            <strong>Ciclo Menstrual Regular:</strong>
                            <span>{{ patient.get_regular_menstrual_cycle_display }}</span>
                        </div>
                    {% endif %}

                    {% if patient.pregnancies_g %}
                        <div class="detail-item">
                            <strong>Gestaciones (G):</strong>
                            <span>{{ patient.pregnancies_g }}</span>
                        </div>
                    {% endif %}

                    {% if patient.abortions_a %}
                        <div class="detail-item">
                            <strong>Abortos (A):</strong>
                            <span>{{ patient.abortions_a }}</span>
                        </div>
                    {% endif %}

                    {% if patient.losses_p %}
                        <div class="detail-item">
                            <strong>Pérdidas (P):</strong>
                            <span>{{ patient.losses_p }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.episiotomies %}
                        <div class="detail-item">
                            <strong>Episiotomías:</strong>
                            <span>{{ patient.get_episiotomies_display }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.prolapse %}
                        <div class="detail-item">
                            <strong>Prolapso:</strong>
                            <span>{{ patient.get_prolapse_display }}{% if patient.prolapse_type %} ({{ patient.prolapse_type }}){% endif %}</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Indicadores ginecológicos -->
                {% if patient.io or patient.if_field or patient.ig %}
                    <div class="indicators-section">
                        <strong>Indicadores:</strong>
                        <div class="indicator-badges">
                            {% if patient.io %}<span class="indicator-badge">IO</span>{% endif %}
                            {% if patient.if_field %}<span class="indicator-badge">IF</span>{% endif %}
                            {% if patient.ig %}<span class="indicator-badge">IG</span>{% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if patient.allergies %}
                    <div class="detail-item full-width">
                        <strong>Alergias:</strong>
                        <span>{{ patient.allergies|linebreaks }}</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- SECCIÓN 3: HÁBITOS DE VIDA -->
        <div class="clinical-section">
            <h3 class="section-title">🏃‍♀️ Hábitos de Vida</h3>
            <div class="section-content">
                <div class="detail-grid">
                    {% if patient.smoking %}
                        <div class="detail-item">
                            <strong>Fuma:</strong>
                            <span>{{ patient.get_smoking_display }}</span>
                        </div>
                    {% endif %}

                    {% if patient.alcohol %}
                        <div class="detail-item">
                            <strong>Alcohol:</strong>
                            <span>{{ patient.get_alcohol_display }}</span>
                        </div>
                    {% endif %}

                    {% if patient.daily_liquid_consumption %}
                        <div class="detail-item">
                            <strong>Consumo Líquido Diario:</strong>
                            <span>{{ patient.daily_liquid_consumption }}</span>
                        </div>
                    {% endif %}
                </div>

                {% if patient.physical_activity %}
                    <div class="detail-item full-width">
                        <strong>Actividad Física:</strong>
                        <span>{{ patient.physical_activity|linebreaks }}</span>
                    </div>
                {% endif %}

                {% if patient.diet %}
                    <div class="detail-item full-width">
                        <strong>Dieta:</strong>
                        <span>{{ patient.diet|linebreaks }}</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- SECCIÓN 4: FUNCIÓN URINARIA -->
        <div class="clinical-section">
            <h3 class="section-title">💧 Función Urinaria</h3>
            <div class="section-content">
                <div class="detail-grid">
                    {% if patient.daily_frequency %}
                        <div class="detail-item">
                            <strong>Frecuencia Diaria:</strong>
                            <span>{{ patient.daily_frequency }}</span>
                        </div>
                    {% endif %}

                    {% if patient.nocturnal_frequency %}
                        <div class="detail-item">
                            <strong>Frecuencia Nocturna:</strong>
                            <span>{{ patient.nocturnal_frequency }}</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Síntomas urinarios -->
                {% if patient.pollakiuria or patient.nocturia or patient.urgency or patient.polyuria or patient.dysuria or patient.latency or patient.effort_to_urinate or patient.incomplete_emptying or patient.immediate_need or patient.terminal_dripping or patient.nocturnal_urgency %}
                    <div class="symptoms-section">
                        <strong>Síntomas Urinarios:</strong>
                        <div class="symptom-badges">
                            {% if patient.pollakiuria %}<span class="symptom-badge">Polaquiuria</span>{% endif %}
                            {% if patient.nocturia %}<span class="symptom-badge">Nocturia</span>{% endif %}
                            {% if patient.urgency %}<span class="symptom-badge">Urgencia</span>{% endif %}
                            {% if patient.polyuria %}<span class="symptom-badge">Poliuria</span>{% endif %}
                            {% if patient.dysuria %}<span class="symptom-badge">Disuria</span>{% endif %}
                            {% if patient.latency %}<span class="symptom-badge">Latencia</span>{% endif %}
                            {% if patient.effort_to_urinate %}<span class="symptom-badge">Esfuerzo para Orinar</span>{% endif %}
                            {% if patient.incomplete_emptying %}<span class="symptom-badge">Vaciamiento Incompleto</span>{% endif %}
                            {% if patient.immediate_need %}<span class="symptom-badge">Necesidad Inmediata</span>{% endif %}
                            {% if patient.terminal_dripping %}<span class="symptom-badge">Goteo Terminal</span>{% endif %}
                            {% if patient.nocturnal_urgency %}<span class="symptom-badge">Urgencia Nocturna</span>{% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if patient.urination_position %}
                    <div class="detail-item full-width">
                        <strong>Posición para Micción:</strong>
                        <span>{{ patient.urination_position|linebreaks }}</span>
                    </div>
                {% endif %}

                {% if patient.stream_description %}
                    <div class="detail-item full-width">
                        <strong>Descripción del Chorro:</strong>
                        <span>{{ patient.stream_description|linebreaks }}</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- SUBSECCIÓN: INCONTINENCIA ORINA -->
        {% if patient.iue or patient.iuu or patient.ium or patient.iu_posture or patient.iu_sensitivity or patient.iu_coital or patient.incontinence_other or patient.activities_stopped %}
            <div class="clinical-section subsection">
                <h3 class="section-title">💦 Incontinencia Orina</h3>
                <div class="section-content">
                    <!-- Tipos de incontinencia -->
                    {% if patient.iue or patient.iuu or patient.ium or patient.iu_posture or patient.iu_sensitivity or patient.iu_coital %}
                        <div class="symptoms-section">
                            <strong>Tipos de Incontinencia:</strong>
                            <div class="symptom-badges">
                                {% if patient.iue %}<span class="symptom-badge">IUE</span>{% endif %}
                                {% if patient.iuu %}<span class="symptom-badge">IUU</span>{% endif %}
                                {% if patient.ium %}<span class="symptom-badge">IUM</span>{% endif %}
                                {% if patient.iu_posture %}<span class="symptom-badge">IU Postura</span>{% endif %}
                                {% if patient.iu_sensitivity %}<span class="symptom-badge">IU Sensibilidad</span>{% endif %}
                                {% if patient.iu_coital %}<span class="symptom-badge">IU Coital</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if patient.activities_stopped %}
                        <div class="detail-item full-width">
                            <strong>Actividades Dejadas por el Problema:</strong>
                            <span>{{ patient.activities_stopped|linebreaks }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- SECCIÓN 5: FUNCIONAMIENTO INTESTINAL -->
        <div class="clinical-section">
            <h3 class="section-title">🦴 Funcionamiento Intestinal</h3>
            <div class="section-content">
                <!-- Síntomas intestinales -->
                {% if patient.constipation or patient.fecal_incontinence or patient.gas_incontinence or patient.hemorrhoids or patient.rectocele or patient.position_frequency or patient.gas_stool_discrimination or patient.painful_evacuation or patient.straining_defecation or patient.complete_evacuation or patient.laxatives or patient.plugging_sensation %}
                    <div class="symptoms-section">
                        <strong>Síntomas Intestinales:</strong>
                        <div class="symptom-badges">
                            {% if patient.constipation %}<span class="symptom-badge">Estreñimiento</span>{% endif %}
                            {% if patient.fecal_incontinence %}<span class="symptom-badge">Incontinencia</span>{% endif %}
                            {% if patient.gas_incontinence %}<span class="symptom-badge">Incontinencia Gases</span>{% endif %}
                            {% if patient.hemorrhoids %}<span class="symptom-badge">Hemorroides</span>{% endif %}
                            {% if patient.rectocele %}<span class="symptom-badge">Rectocele</span>{% endif %}
                            {% if patient.position_frequency %}<span class="symptom-badge">Frecuencia Posiciones</span>{% endif %}
                            {% if patient.gas_stool_discrimination %}<span class="symptom-badge">Discriminación Gas/Caca</span>{% endif %}
                            {% if patient.painful_evacuation %}<span class="symptom-badge">Evacuación Dolorosa</span>{% endif %}
                            {% if patient.straining_defecation %}<span class="symptom-badge">Puja para Defecar</span>{% endif %}
                            {% if patient.complete_evacuation %}<span class="symptom-badge">Evacuación Completa</span>{% endif %}
                            {% if patient.laxatives %}<span class="symptom-badge">Laxantes</span>{% endif %}
                            {% if patient.plugging_sensation %}<span class="symptom-badge">Sensación de Tapón</span>{% endif %}
                        </div>
                    </div>
                {% endif %}

                <div class="detail-grid">
                    {% if patient.bristol_scale %}
                        <div class="detail-item">
                            <strong>Escala Bristol:</strong>
                            <span>{{ patient.bristol_scale }}/7</span>
                        </div>
                    {% endif %}
                </div>

                {% if patient.defecation_position %}
                    <div class="detail-item full-width">
                        <strong>Posición para Defecar:</strong>
                        <span>{{ patient.defecation_position|linebreaks }}</span>
                    </div>
                {% endif %}

                {% if patient.bowel_activities_stopped %}
                    <div class="detail-item full-width">
                        <strong>Actividades Dejadas por el Problema:</strong>
                        <span>{{ patient.bowel_activities_stopped|linebreaks }}</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- SECCIÓN 6: HISTORIAL SEXUAL -->
        {% if patient.sexually_active or patient.sexual_desire or patient.sexual_excitement or patient.orgasm or patient.dyspareunia or patient.urge_to_urinate_during_sex or patient.vaginal_dryness or patient.impaired_by_incontinence or patient.urinary_incontinence_sexual or patient.fecal_incontinence_sexual %}
            <div class="clinical-section">
                <h3 class="section-title">💕 Historial Sexual</h3>
                <div class="section-content">
                    {% if patient.sexually_active %}
                        <div class="detail-item">
                            <strong>Activo Sexualmente:</strong>
                            <span>Sí{% if patient.sexually_active_when %} ({{ patient.sexually_active_when }}){% endif %}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Síntomas sexuales -->
                    {% if patient.sexual_desire or patient.sexual_excitement or patient.orgasm or patient.dyspareunia or patient.urge_to_urinate_during_sex or patient.vaginal_dryness or patient.impaired_by_incontinence %}
                        <div class="symptoms-section">
                            <strong>Síntomas Sexuales:</strong>
                            <div class="symptom-badges">
                                {% if patient.sexual_desire %}<span class="symptom-badge">Deseo Sexual</span>{% endif %}
                                {% if patient.sexual_excitement %}<span class="symptom-badge">Excitación</span>{% endif %}
                                {% if patient.orgasm %}<span class="symptom-badge">Orgasmo</span>{% endif %}
                                {% if patient.dyspareunia %}<span class="symptom-badge">Dispareunia</span>{% endif %}
                                {% if patient.urge_to_urinate_during_sex %}<span class="symptom-badge">Deseo de Orinar Durante</span>{% endif %}
                                {% if patient.vaginal_dryness %}<span class="symptom-badge">Resequedad</span>{% endif %}
                                {% if patient.impaired_by_incontinence %}<span class="symptom-badge">Perjudicado por Incontinencia</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Incontinencia durante actividad sexual -->
                    {% if patient.urinary_incontinence_sexual or patient.fecal_incontinence_sexual %}
                        <div class="symptoms-section">
                            <strong>Incontinencia Durante Actividad Sexual:</strong>
                            <div class="symptom-badges">
                                {% if patient.urinary_incontinence_sexual %}<span class="symptom-badge">Incontinencia Orina</span>{% endif %}
                                {% if patient.fecal_incontinence_sexual %}<span class="symptom-badge">Incontinencia Fecal</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- SECCIÓN 7: EXAMEN FÍSICO -->
        {% if patient.diastasis or patient.scars or patient.adherences or patient.skin_coloration or patient.push_exam or patient.nlp_tone_contraction or patient.nlp_tone_relaxation or patient.nlp_tone_push or patient.nlp_tone_pain or patient.anal_cutaneous_reflex or patient.vulvo_cavernous_reflex or patient.cough_reflex %}
            <div class="clinical-section">
                <h3 class="section-title">🔍 Examen Físico</h3>
                <div class="section-content">
                    <div class="detail-grid">
                        {% if patient.push_exam %}
                            <div class="detail-item">
                                <strong>Pujo:</strong>
                                <span>{{ patient.get_push_exam_display }}</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if patient.diastasis %}
                        <div class="detail-item full-width">
                            <strong>Diastasis:</strong>
                            <span>{{ patient.diastasis|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.scars %}
                        <div class="detail-item full-width">
                            <strong>Cicatrices:</strong>
                            <span>{{ patient.scars|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.adherences %}
                        <div class="detail-item full-width">
                            <strong>Adherencias:</strong>
                            <span>{{ patient.adherences|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.skin_coloration %}
                        <div class="detail-item full-width">
                            <strong>Coloración de la Piel:</strong>
                            <span>{{ patient.skin_coloration|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- NLP Tono -->
                    {% if patient.nlp_tone_contraction or patient.nlp_tone_relaxation or patient.nlp_tone_push or patient.nlp_tone_pain %}
                        <div class="subsection-detail">
                            <h4>NLP - Tono</h4>
                            {% if patient.nlp_tone_contraction %}
                                <div class="detail-item">
                                    <strong>Contracción:</strong>
                                    <span>{{ patient.nlp_tone_contraction|linebreaks }}</span>
                                </div>
                            {% endif %}
                            {% if patient.nlp_tone_relaxation %}
                                <div class="detail-item">
                                    <strong>Relajación:</strong>
                                    <span>{{ patient.nlp_tone_relaxation|linebreaks }}</span>
                                </div>
                            {% endif %}
                            {% if patient.nlp_tone_push %}
                                <div class="detail-item">
                                    <strong>Pujo:</strong>
                                    <span>{{ patient.nlp_tone_push|linebreaks }}</span>
                                </div>
                            {% endif %}
                            {% if patient.nlp_tone_pain %}
                                <div class="detail-item">
                                    <strong>Dolor:</strong>
                                    <span>{{ patient.nlp_tone_pain|linebreaks }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Reflejos -->
                    {% if patient.anal_cutaneous_reflex or patient.vulvo_cavernous_reflex or patient.cough_reflex %}
                        <div class="symptoms-section">
                            <strong>Sensibilidad y Reflejo (S2-S4):</strong>
                            <div class="symptom-badges">
                                {% if patient.anal_cutaneous_reflex %}<span class="symptom-badge">Reflejo Cutáneo Anal</span>{% endif %}
                                {% if patient.vulvo_cavernous_reflex %}<span class="symptom-badge">Reflejo Vulvo Cavernoso</span>{% endif %}
                                {% if patient.cough_reflex %}<span class="symptom-badge">Reflejo Tusígeno</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- SECCIÓN 8: EXAMEN INTRACAVITARIO -->
        {% if patient.intracavitary_consent or patient.intracavitary_scars or patient.intracavitary_mucosa or patient.mea_tonicity_rest or patient.mea_perception or patient.mea_contraction or patient.mea_pain_eva or patient.urethral_movement or patient.oxford_force %}
            <div class="clinical-section">
                <h3 class="section-title">🔬 Examen Intracavitario</h3>
                <div class="section-content">
                    {% if patient.intracavitary_consent %}
                        <div class="detail-item">
                            <strong>Consentimiento:</strong>
                            <span>Sí</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.intracavitary_scars %}
                        <div class="detail-item full-width">
                            <strong>Cicatrices:</strong>
                            <span>{{ patient.intracavitary_scars|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.intracavitary_mucosa %}
                        <div class="detail-item full-width">
                            <strong>Mucosa:</strong>
                            <span>{{ patient.intracavitary_mucosa|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- MEA -->
                    {% if patient.mea_tonicity_rest or patient.mea_perception or patient.mea_contraction or patient.mea_symmetry_rest or patient.mea_symmetry_contraction or patient.mea_voluntary_relaxation %}
                        <div class="subsection-detail">
                            <h4>MEA (Músculos del Elevador del Ano)</h4>
                            <div class="detail-grid">
                                {% if patient.mea_tonicity_rest %}
                                    <div class="detail-item">
                                        <strong>Tonicidad Reposo:</strong>
                                        <span>{{ patient.mea_tonicity_rest }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.mea_perception %}
                                    <div class="detail-item">
                                        <strong>Percepción:</strong>
                                        <span>{{ patient.mea_perception }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.mea_contraction %}
                                    <div class="detail-item">
                                        <strong>Contracción:</strong>
                                        <span>{{ patient.mea_contraction }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.mea_voluntary_relaxation %}
                                    <div class="detail-item">
                                        <strong>Relajación Voluntaria:</strong>
                                        <span>{{ patient.mea_voluntary_relaxation }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Dolor MEA -->
                    {% if patient.mea_pain_eva or patient.mea_pain_location or patient.mea_pain_when or patient.mea_pain_description %}
                        <div class="subsection-detail">
                            <h4>Dolor MEA</h4>
                            <div class="detail-grid">
                                {% if patient.mea_pain_eva %}
                                    <div class="detail-item">
                                        <strong>EVA:</strong>
                                        <span>{{ patient.mea_pain_eva }}/10</span>
                                    </div>
                                {% endif %}
                                {% if patient.mea_pain_location %}
                                    <div class="detail-item">
                                        <strong>Dónde:</strong>
                                        <span>{{ patient.mea_pain_location }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.mea_pain_when %}
                                    <div class="detail-item">
                                        <strong>Cuándo:</strong>
                                        <span>{{ patient.mea_pain_when }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            {% if patient.mea_pain_description %}
                                <div class="detail-item full-width">
                                    <strong>Descripción:</strong>
                                    <span>{{ patient.mea_pain_description|linebreaks }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    {% if patient.oxford_force %}
                        <div class="detail-item full-width">
                            <strong>Fuerza (Oxford):</strong>
                            <span>{{ patient.oxford_force|linebreaks }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- SECCIÓN 9: EXAMEN COLOPROCTOLÓGICO -->
        {% if patient.coloproctologic_consent or patient.anal_canal_closure or patient.irritation or patient.stool_remains or patient.blind_rectum or patient.coloproctologic_scars or patient.coloproctologic_hemorrhoids or patient.rest_tone or patient.resistance or patient.oxford_anorectal_angle or patient.anorectal_opening or patient.rectal_torso_synchronization or patient.anal_canal_relaxation %}
            <div class="clinical-section">
                <h3 class="section-title">🩻 Examen Coloproctológico</h3>
                <div class="section-content">
                    {% if patient.coloproctologic_consent %}
                        <div class="detail-item">
                            <strong>Consentimiento:</strong>
                            <span>Sí</span>
                        </div>
                    {% endif %}
                    
                    <!-- Observaciones -->
                    {% if patient.anal_canal_closure or patient.irritation or patient.stool_remains or patient.blind_rectum %}
                        <div class="symptoms-section">
                            <strong>Observaciones:</strong>
                            <div class="symptom-badges">
                                {% if patient.anal_canal_closure %}<span class="symptom-badge">Cierre Canal Anal</span>{% endif %}
                                {% if patient.irritation %}<span class="symptom-badge">Irritación</span>{% endif %}
                                {% if patient.stool_remains %}<span class="symptom-badge">Resto de Deposiciones</span>{% endif %}
                                {% if patient.blind_rectum %}<span class="symptom-badge">Recto Ciego</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if patient.coloproctologic_scars %}
                        <div class="detail-item full-width">
                            <strong>Cicatrices:</strong>
                            <span>{{ patient.coloproctologic_scars|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.coloproctologic_hemorrhoids %}
                        <div class="detail-item full-width">
                            <strong>Hemorroides:</strong>
                            <span>{{ patient.coloproctologic_hemorrhoids|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Tono y resistencia -->
                    {% if patient.rest_tone or patient.resistance or patient.eae_tonicity_rest or patient.eae_contraction %}
                        <div class="subsection-detail">
                            <h4>Tono y Resistencia</h4>
                            <div class="detail-grid">
                                {% if patient.rest_tone %}
                                    <div class="detail-item">
                                        <strong>Tono en Reposo:</strong>
                                        <span>{{ patient.rest_tone }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.resistance %}
                                    <div class="detail-item">
                                        <strong>Resistencia:</strong>
                                        <span>{{ patient.resistance }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.eae_tonicity_rest %}
                                    <div class="detail-item">
                                        <strong>Tonicidad EAE Reposo:</strong>
                                        <span>{{ patient.eae_tonicity_rest }}</span>
                                    </div>
                                {% endif %}
                                {% if patient.eae_contraction %}
                                    <div class="detail-item">
                                        <strong>Contracción EAE:</strong>
                                        <span>{{ patient.eae_contraction }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if patient.oxford_anorectal_angle %}
                        <div class="detail-item full-width">
                            <strong>Ángulo Ano Rectal (Oxford):</strong>
                            <span>{{ patient.oxford_anorectal_angle|linebreaks }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Empujo -->
                    {% if patient.anorectal_opening or patient.rectal_torso_synchronization or patient.anal_canal_relaxation %}
                        <div class="symptoms-section">
                            <strong>Empujo:</strong>
                            <div class="symptom-badges">
                                {% if patient.anorectal_opening %}<span class="symptom-badge">Apertura Ano Rectal</span>{% endif %}
                                {% if patient.rectal_torso_synchronization %}<span class="symptom-badge">Sincronización Torso Rectal</span>{% endif %}
                                {% if patient.anal_canal_relaxation %}<span class="symptom-badge">Relajación Canal Anal</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        </div>

        <!-- SIDEBAR: HISTORIAL DE CITAS -->
        <div class="sidebar">
            <div class="appointments-section">
                <div class="appointments-header">
                    <h3>📅 Historial de Citas</h3>
                    <a href="{% url 'appointment_create' patient.pk %}" class="btn btn-primary btn-sm">Nueva Cita</a>
                </div>

                {% if appointments %}
                    <div class="appointments-list">
                        {% for appointment in appointments %}
                            <div class="appointment-card">
                                <div class="appointment-header">
                                    <div class="appointment-date">
                                        <strong>{{ appointment.date_time|date:"d/m/Y" }}</strong>
                                    </div>
                                    {% if appointment.session_description %}
                                        <div class="appointment-description">
                                            <strong>Descripción:</strong>
                                            <p>{{ appointment.session_description }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="appointment-content">
                                    <div class="appointment-tasks-and-tests">
                                        {% if appointment.tasks %}
                                            <div class="appointment-tasks">
                                                <strong>Tareas:</strong>
                                                <p>{{ appointment.tasks|linebreaks }}</p>
                                            </div>
                                        {% endif %}

                                        <!-- Test PERFECT -->
                                        {% if appointment.perfect_p_power or appointment.perfect_e_endurance or appointment.perfect_r_repetitions or appointment.perfect_f_fast or appointment.perfect_e_every or appointment.perfect_c_cocontraction or appointment.perfect_t_timing %}
                                            <div class="test-perfect">
                                                <strong>Test PERFECT:</strong>
                                                <div class="perfect-scores">
                                                    {% if appointment.perfect_p_power %}<span class="score">P: {{ appointment.perfect_p_power }}</span>{% endif %}
                                                    {% if appointment.perfect_e_endurance %}<span class="score">E: {{ appointment.perfect_e_endurance }}</span>{% endif %}
                                                    {% if appointment.perfect_r_repetitions %}<span class="score">R: {{ appointment.perfect_r_repetitions }}</span>{% endif %}
                                                    {% if appointment.perfect_f_fast %}<span class="score">F: {{ appointment.perfect_f_fast }}</span>{% endif %}
                                                    {% if appointment.perfect_e_every %}<span class="score">E: {{ appointment.get_perfect_e_every_display }}</span>{% endif %}
                                                    {% if appointment.perfect_c_cocontraction %}<span class="score">C: {{ appointment.get_perfect_c_cocontraction_display }}</span>{% endif %}
                                                    {% if appointment.perfect_t_timing %}<span class="score">T: {{ appointment.get_perfect_t_timing_display }}</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Test del Balón -->
                                    {% if appointment.balloon_rectal_sensation or appointment.balloon_first_desire_volume or appointment.balloon_normal_desire_volume or appointment.balloon_max_tolerable_capacity or appointment.balloon_rectoanal_reflex or appointment.balloon_expulsion %}
                                        <div class="test-balloon">
                                            <strong>Test del Balón:</strong>
                                            <div class="balloon-results">
                                                {% if appointment.balloon_rectal_sensation %}<div class="balloon-item"><small>Sensación rectal:</small> {{ appointment.balloon_rectal_sensation }}</div>{% endif %}
                                                {% if appointment.balloon_first_desire_volume %}<div class="balloon-item"><small>Primer deseo:</small> {{ appointment.balloon_first_desire_volume }}</div>{% endif %}
                                                {% if appointment.balloon_normal_desire_volume %}<div class="balloon-item"><small>Deseo normal:</small> {{ appointment.balloon_normal_desire_volume }}</div>{% endif %}
                                                {% if appointment.balloon_max_tolerable_capacity %}<div class="balloon-item"><small>Capacidad máx:</small> {{ appointment.balloon_max_tolerable_capacity }}</div>{% endif %}
                                                {% if appointment.balloon_rectoanal_reflex %}<div class="balloon-item"><small>Reflejo rectoanal:</small> {{ appointment.get_balloon_rectoanal_reflex_display }}</div>{% endif %}
                                                {% if appointment.balloon_expulsion %}<div class="balloon-item"><small>Expulsión:</small> {{ appointment.get_balloon_expulsion_display }}</div>{% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    {% if appointment.additional_notes %}
                                        <div class="appointment-notes">
                                            <strong>Notas Adicionales:</strong>
                                            <p>{{ appointment.additional_notes|linebreaks }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="appointment-actions">
                                    <a href="{% url 'appointment_update' appointment.pk %}" class="btn btn-sm btn-primary">Editar</a>
                                    <a href="{% url 'appointment_delete' appointment.pk %}" class="btn btn-sm btn-danger">Eliminar</a>
                                    <small class="text-muted">{{ appointment.created_at|date:"d/m/Y H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-appointments">
                        <p>No hay citas registradas.</p>
                        <a href="{% url 'appointment_create' patient.pk %}" class="btn btn-primary btn-sm">Primera Cita</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
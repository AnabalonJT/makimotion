{% extends 'base.html' %}

{% block title %}{{ patient.full_name }} - Ficha Cl√≠nica - MakiMotion{% endblock %}

{% block content %}
<div class="clinical-detail-container">
    <div class="patient-header">
        <div class="patient-info">
            <h2>{{ patient.full_name }}</h2>
            <div class="patient-meta">
                <span class="patient-age">{{ patient.age }} a√±os</span>
                <span class="patient-profession">{{ patient.profession|default:"Sin profesi√≥n" }}</span>
                <span class="patient-created">Registrado: {{ patient.created_at|date:"d/m/Y" }}</span>
            </div>
            
            <!-- Fichas Cl√≠nicas Recientes -->
            {% if recent_fichas %}
            <div class="recent-fichas-header">
                <h4>Fichas Cl√≠nicas Recientes</h4>
                <div class="fichas-timeline">
                    {% for ficha in recent_fichas %}
                    <div class="ficha-item">
                        <div class="ficha-date">{{ ficha.created_at|date:"d/m/Y" }}</div>
                        <div class="ficha-motivo">
                            <strong>Motivo de consulta:</strong>
                            {{ ficha.consultation_reason|truncatechars:50|default:"Sin motivo especificado" }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="patient-actions">
            <button type="button" onclick="window.location.href='{% url 'patient_update' patient.pk %}'" class="btn btn-primary">Editar Paciente</button>
            <button type="button" onclick="window.location.href='{% url 'patient_delete' patient.pk %}'" class="btn btn-danger">Eliminar</button>
            <button type="button" onclick="window.location.href='{% url 'dashboard' %}'" class="btn btn-secondary">Volver al Dashboard</button>
            {% if not patient.alta %}
                <form method="post" action="{% url 'patient_update' patient.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="alta" value="true">
                    <button type="submit" class="btn btn-success">Dar de Alta</button>
                </form>
            {% else %}
                <span class="badge bg-success ms-2">Paciente dado de alta</span>
            {% endif %}
        </div>
    </div>

    <div class="patient-content-layout">
        <div class="main-content-column">
            <!-- SECCI√ìN 1: DATOS DEL PACIENTE -->
            <div class="clinical-section">
                <h3 class="section-title">üìã Datos del Paciente</h3>
                <div class="section-content">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Nombre Completo:</strong>
                                <span>{{ patient.full_name }}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Edad:</strong>
                                <span>{{ patient.age }} a√±os</span>
                            </div>
                            <div class="detail-item">
                                <strong>Profesi√≥n:</strong>
                                <span>{{ patient.profession|default:"No especificada" }}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Tel√©fono:</strong>
                                <span>{{ patient.phone|default:"No especificado" }}</span>
                            </div>
                        </div>

                        {% if patient.address %}
                            <div class="detail-item full-width">
                                <strong>Direcci√≥n:</strong>
                                <span>{{ patient.address }}</span>
                            </div>
                        {% endif %}

                        {% if patient.consultation_reason %}
                            <div class="detail-item full-width">
                                <strong>Motivo de Consulta:</strong>
                                <span>{{ patient.consultation_reason|linebreaks }}</span>
                            </div>
                        {% endif %}

                        {% if patient.medications %}
                            <div class="detail-item full-width">
                                <strong>Medicamentos:</strong>
                                <span>{{ patient.medications|linebreaks }}</span>
                            </div>
                        {% endif %}

                        {% if patient.musculoskeletal_history %}
                            <div class="detail-item full-width">
                                <strong>Antecedentes M√∫sculo Esquel√©tico:</strong>
                                <span>{{ patient.musculoskeletal_history|linebreaks }}</span>
                            </div>
                        {% endif %}
                        {% if patient.patient_data_other %}
                            <div class="detail-item full-width">
                                <strong>Otros Datos:</strong>
                                <span>{{ patient.patient_data_other|linebreaks }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

               <!-- SECCI√ìN: FICHA CL√çNICA -->
                <div class="clinical-section">
                    <div class="section-header-with-date">
                        <h3 class="section-title">üè• Ficha Cl√≠nica</h3>
                        {% if latest_ficha %}
                            <span class="ficha-date">{{ latest_ficha.created_at|date:"d/m/Y" }}</span>
                        {% endif %}
                    </div>
                    <div class="section-content">
                        {% if latest_ficha %}
                            <!-- MOTIVO DE CONSULTA -->
                            {% if latest_ficha.consultation_reason %}
                                <div class="ficha-subsection">
                                    <div class="detail-item full-width">
                                        <strong>Motivo de Consulta:</strong>
                                        <span>{{ latest_ficha.consultation_reason|linebreaks }}</span>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- APRENDIZAJES GENERALES -->
                            <div class="ficha-subsection">
                                <h4 class="subsection-title">üß† Aprendizajes Generales</h4>
                                <div class="subsection-content">
                                    <div class="symptoms-section">
                                        <strong>Aprendizajes:</strong>
                                        <div class="symptom-badges">
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_pujo_caca %}learned{% else %}not-learned{% endif %}">Pujo Caca</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_banquito %}learned{% else %}not-learned{% endif %}">Uso de Banquito</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_transverso %}learned{% else %}not-learned{% endif %}">Activaci√≥n Transverso</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_respiracion_pelvico %}learned{% else %}not-learned{% endif %}">Respiraci√≥n + Piso P√©lvico</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_contraccion_pelvico %}learned{% else %}not-learned{% endif %}">Contracci√≥n Piso P√©lvico</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_preapretar %}learned{% else %}not-learned{% endif %}">Preapretar</span>
                                        </div>
                                    </div>
                                    {% if latest_ficha.aprendizaje_otros %}
                                        <div class="detail-item full-width">
                                            <strong>Otros Aprendizajes:</strong>
                                            <span>{{ latest_ficha.aprendizaje_otros|linebreaks }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- APRENDIZAJES EMBARAZO -->
                            <div class="ficha-subsection">
                                <h4 class="subsection-title">ü§∞ Aprendizajes Embarazo</h4>
                                <div class="subsection-content">
                                    <div class="symptoms-section">
                                        <strong>Aprendizajes:</strong>
                                        <div class="symptom-badges">
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_oms %}learned{% else %}not-learned{% endif %}">OMS</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_anatomia %}learned{% else %}not-learned{% endif %}">Anatom√≠a</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_movimientos %}learned{% else %}not-learned{% endif %}">Movimientos Cardinales</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_posicion_trabajo %}learned{% else %}not-learned{% endif %}">Posici√≥n Trabajo Parto</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_posicion_expulsion %}learned{% else %}not-learned{% endif %}">Posici√≥n Expulsi√≥n</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_intervencion %}learned{% else %}not-learned{% endif %}">Intervenci√≥n Obst√©trica</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_masaje_perineal %}learned{% else %}not-learned{% endif %}">Masaje Perineal</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_respiraciones %}learned{% else %}not-learned{% endif %}">Respiraciones</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_pujo %}learned{% else %}not-learned{% endif %}">Pujo Embarazo</span>
                                            <span class="symptom-badge {% if latest_ficha.aprendizaje_emb_tecnicas_dolor %}learned{% else %}not-learned{% endif %}">T√©cnicas de Dolor</span>
                                        </div>
                                    </div>
                                    {% if latest_ficha.aprendizaje_emb_otros %}
                                        <div class="detail-item full-width">
                                            <strong>Otros Aprendizajes Embarazo:</strong>
                                            <span>{{ latest_ficha.aprendizaje_emb_otros|linebreaks }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- H√ÅBITOS DE VIDA -->
                            {% if latest_ficha.smoking or latest_ficha.alcohol or latest_ficha.physical_activity or latest_ficha.diet or latest_ficha.daily_liquid_consumption or latest_ficha.lifestyle_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">üèÉ H√°bitos de Vida</h4>
                                    <div class="subsection-content">
                                        <div class="detail-grid">
                                            {% if latest_ficha.smoking %}
                                                <div class="detail-item">
                                                    <strong>Fuma:</strong>
                                                    <span>{{ latest_ficha.get_smoking_display }}</span>
                                                </div>
                                            {% endif %}
                                            {% if latest_ficha.alcohol %}
                                                <div class="detail-item">
                                                    <strong>Alcohol:</strong>
                                                    <span>{{ latest_ficha.get_alcohol_display }}</span>
                                                </div>
                                            {% endif %}
                                            {% if latest_ficha.daily_liquid_consumption %}
                                                <div class="detail-item">
                                                    <strong>Consumo L√≠quido Diario:</strong>
                                                    <span>{{ latest_ficha.daily_liquid_consumption }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if latest_ficha.physical_activity %}
                                            <div class="detail-item full-width">
                                                <strong>Actividad F√≠sica:</strong>
                                                <span>{{ latest_ficha.physical_activity|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.diet %}
                                            <div class="detail-item full-width">
                                                <strong>Dieta:</strong>
                                                <span>{{ latest_ficha.diet|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.lifestyle_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.lifestyle_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- FUNCI√ìN URINARIA -->
                            {% if latest_ficha.daily_frequency_initial or latest_ficha.daily_frequency_final or latest_ficha.nocturnal_frequency_initial or latest_ficha.nocturnal_frequency_final or latest_ficha.pollakiuria or latest_ficha.nocturia or latest_ficha.urgency or latest_ficha.polyuria or latest_ficha.dysuria or latest_ficha.latency or latest_ficha.effort_to_urinate or latest_ficha.incomplete_emptying or latest_ficha.immediate_need or latest_ficha.terminal_dripping or latest_ficha.nocturnal_urgency or latest_ficha.urination_position or latest_ficha.stream_description or latest_ficha.urinary_function_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">üíß Funci√≥n Urinaria</h4>
                                    <div class="subsection-content">
                                        <div class="detail-grid">
                                            {% if latest_ficha.daily_frequency_initial %}
                                                <div class="detail-item">
                                                    <strong>Frecuencia Diaria Inicial:</strong>
                                                    <span>{{ latest_ficha.daily_frequency_initial }}</span>
                                                </div>
                                            {% endif %}
                                            {% if latest_ficha.daily_frequency_final %}
                                                <div class="detail-item">
                                                    <strong>Frecuencia Diaria Final:</strong>
                                                    <span>{{ latest_ficha.daily_frequency_final }}</span>
                                                </div>
                                            {% endif %}
                                            {% if latest_ficha.nocturnal_frequency_initial %}
                                                <div class="detail-item">
                                                    <strong>Frecuencia Nocturna Inicial:</strong>
                                                    <span>{{ latest_ficha.nocturnal_frequency_initial }}</span>
                                                </div>
                                            {% endif %}
                                            {% if latest_ficha.nocturnal_frequency_final %}
                                                <div class="detail-item">
                                                    <strong>Frecuencia Nocturna Final:</strong>
                                                    <span>{{ latest_ficha.nocturnal_frequency_final }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if latest_ficha.pollakiuria or latest_ficha.nocturia or latest_ficha.urgency or latest_ficha.polyuria or latest_ficha.dysuria or latest_ficha.latency or latest_ficha.effort_to_urinate or latest_ficha.incomplete_emptying or latest_ficha.immediate_need or latest_ficha.terminal_dripping or latest_ficha.nocturnal_urgency %}
                                            <div class="symptoms-section">
                                                <strong>S√≠ntomas Urinarios:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.pollakiuria %}<span class="symptom-badge">Polaquiuria</span>{% endif %}
                                                    {% if latest_ficha.nocturia %}<span class="symptom-badge">Nocturia</span>{% endif %}
                                                    {% if latest_ficha.urgency %}<span class="symptom-badge">Urgencia</span>{% endif %}
                                                    {% if latest_ficha.polyuria %}<span class="symptom-badge">Poliuria</span>{% endif %}
                                                    {% if latest_ficha.dysuria %}<span class="symptom-badge">Disuria</span>{% endif %}
                                                    {% if latest_ficha.latency %}<span class="symptom-badge">Latencia</span>{% endif %}
                                                    {% if latest_ficha.effort_to_urinate %}<span class="symptom-badge">Esfuerzo para Orinar</span>{% endif %}
                                                    {% if latest_ficha.incomplete_emptying %}<span class="symptom-badge">Vaciamiento Incompleto</span>{% endif %}
                                                    {% if latest_ficha.immediate_need %}<span class="symptom-badge">Necesidad Inmediata</span>{% endif %}
                                                    {% if latest_ficha.terminal_dripping %}<span class="symptom-badge">Goteo Terminal</span>{% endif %}
                                                    {% if latest_ficha.nocturnal_urgency %}<span class="symptom-badge">Urgencia Nocturna</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.urination_position %}
                                            <div class="detail-item full-width">
                                                <strong>Posici√≥n para Micci√≥n:</strong>
                                                <span>{{ latest_ficha.urination_position|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.stream_description %}
                                            <div class="detail-item full-width">
                                                <strong>Descripci√≥n del Chorro:</strong>
                                                <span>{{ latest_ficha.stream_description|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.urinary_function_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.urinary_function_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}

                                        <!-- SUBSECCI√ìN: INCONTINENCIA ORINA -->
                                        {% if latest_ficha.iue or latest_ficha.iuu or latest_ficha.ium or latest_ficha.iu_posture or latest_ficha.iu_sensitivity or latest_ficha.iu_coital or latest_ficha.incontinence_other or latest_ficha.activities_stopped %}
                                            <div class="subsubsection">
                                                <h5>üí¶ Incontinencia Orina</h5>
                                                {% if latest_ficha.iue or latest_ficha.iuu or latest_ficha.ium or latest_ficha.iu_posture or latest_ficha.iu_sensitivity or latest_ficha.iu_coital %}
                                                    <div class="symptoms-section">
                                                        <strong>Tipos de Incontinencia:</strong>
                                                        <div class="symptom-badges">
                                                            {% if latest_ficha.iue %}<span class="symptom-badge">IUE</span>{% endif %}
                                                            {% if latest_ficha.iuu %}<span class="symptom-badge">IUU</span>{% endif %}
                                                            {% if latest_ficha.ium %}<span class="symptom-badge">IUM</span>{% endif %}
                                                            {% if latest_ficha.iu_posture %}<span class="symptom-badge">IU Postura</span>{% endif %}
                                                            {% if latest_ficha.iu_sensitivity %}<span class="symptom-badge">IU Sensibilidad</span>{% endif %}
                                                            {% if latest_ficha.iu_coital %}<span class="symptom-badge">IU Coital</span>{% endif %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                                {% if latest_ficha.activities_stopped %}
                                                    <div class="detail-item full-width">
                                                        <strong>Actividades Dejadas por el Problema:</strong>
                                                        <span>{{ latest_ficha.activities_stopped|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- FUNCIONAMIENTO INTESTINAL -->
                            {% if latest_ficha.constipation or latest_ficha.fecal_incontinence or latest_ficha.gas_incontinence or latest_ficha.hemorrhoids or latest_ficha.rectocele or latest_ficha.gas_stool_discrimination or latest_ficha.painful_evacuation or latest_ficha.straining_defecation or latest_ficha.complete_evacuation or latest_ficha.laxatives or latest_ficha.plugging_sensation or latest_ficha.defecation_position or latest_ficha.bristol_scale or latest_ficha.position_frequency or latest_ficha.bowel_inconsistency or latest_ficha.bowel_conscious or latest_ficha.bowel_pad or latest_ficha.bowel_activities_stopped or latest_ficha.bowel_function_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">ü¶¥ Funcionamiento Intestinal</h4>
                                    <div class="subsection-content">
                                        {% if latest_ficha.constipation or latest_ficha.fecal_incontinence or latest_ficha.gas_incontinence or latest_ficha.hemorrhoids or latest_ficha.rectocele or latest_ficha.gas_stool_discrimination or latest_ficha.painful_evacuation or latest_ficha.straining_defecation or latest_ficha.complete_evacuation or latest_ficha.laxatives or latest_ficha.plugging_sensation %}
                                            <div class="symptoms-section">
                                                <strong>S√≠ntomas Intestinales:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.constipation %}<span class="symptom-badge">Estre√±imiento</span>{% endif %}
                                                    {% if latest_ficha.fecal_incontinence %}<span class="symptom-badge">Incontinencia</span>{% endif %}
                                                    {% if latest_ficha.gas_incontinence %}<span class="symptom-badge">Incontinencia Gases</span>{% endif %}
                                                    {% if latest_ficha.hemorrhoids %}<span class="symptom-badge">Hemorroides</span>{% endif %}
                                                    {% if latest_ficha.rectocele %}<span class="symptom-badge">Rectocele</span>{% endif %}
                                                    {% if latest_ficha.gas_stool_discrimination %}<span class="symptom-badge">Discriminaci√≥n Gas/Caca</span>{% endif %}
                                                    {% if latest_ficha.painful_evacuation %}<span class="symptom-badge">Evacuaci√≥n Dolorosa</span>{% endif %}
                                                    {% if latest_ficha.straining_defecation %}<span class="symptom-badge">Puja para Defecar</span>{% endif %}
                                                    {% if latest_ficha.complete_evacuation %}<span class="symptom-badge">Evacuaci√≥n Completa</span>{% endif %}
                                                    {% if latest_ficha.laxatives %}<span class="symptom-badge">Laxantes</span>{% endif %}
                                                    {% if latest_ficha.plugging_sensation %}<span class="symptom-badge">Sensaci√≥n de Tap√≥n</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="detail-grid">
                                            {% if latest_ficha.bristol_scale %}
                                                <div class="detail-item">
                                                    <strong>Escala Bristol:</strong>
                                                    <span>{{ latest_ficha.bristol_scale }}/7</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if latest_ficha.defecation_position %}
                                            <div class="detail-item full-width">
                                                <strong>Posici√≥n para Defecar:</strong>
                                                <span>{{ latest_ficha.defecation_position|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.bowel_activities_stopped %}
                                            <div class="detail-item full-width">
                                                <strong>Actividades Dejadas por el Problema:</strong>
                                                <span>{{ latest_ficha.bowel_activities_stopped|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.bowel_function_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.bowel_function_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- HISTORIAL SEXUAL -->
                            {% if latest_ficha.sexual_status or latest_ficha.urinary_incontinence_sexual or latest_ficha.fecal_incontinence_sexual or latest_ficha.sexual_desire or latest_ficha.sexual_excitement or latest_ficha.orgasm or latest_ficha.dyspareunia or latest_ficha.urge_to_urinate_during_sex or latest_ficha.vaginal_dryness or latest_ficha.impaired_by_incontinence or latest_ficha.sexual_history_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">üíï Historial Sexual</h4>
                                    <div class="subsection-content">
                                        {% if latest_ficha.sexual_status %}
                                            <div class="detail-item">
                                                <strong>Estado Sexual:</strong>
                                                <span>{{ latest_ficha.get_sexual_status_display }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.urinary_incontinence_sexual or latest_ficha.fecal_incontinence_sexual %}
                                            <div class="symptoms-section">
                                                <strong>Incontinencia Durante Actividad Sexual:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.urinary_incontinence_sexual %}<span class="symptom-badge">Incontinencia Orina</span>{% endif %}
                                                    {% if latest_ficha.fecal_incontinence_sexual %}<span class="symptom-badge">Incontinencia Fecal</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.sexual_desire or latest_ficha.sexual_excitement or latest_ficha.orgasm or latest_ficha.dyspareunia or latest_ficha.urge_to_urinate_during_sex or latest_ficha.vaginal_dryness or latest_ficha.impaired_by_incontinence %}
                                            <div class="symptoms-section">
                                                <strong>S√≠ntomas Sexuales:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.sexual_desire %}<span class="symptom-badge">Deseo Sexual</span>{% endif %}
                                                    {% if latest_ficha.sexual_excitement %}<span class="symptom-badge">Excitaci√≥n</span>{% endif %}
                                                    {% if latest_ficha.orgasm %}<span class="symptom-badge">Orgasmo</span>{% endif %}
                                                    {% if latest_ficha.dyspareunia %}<span class="symptom-badge">Dispareunia</span>{% endif %}
                                                    {% if latest_ficha.urge_to_urinate_during_sex %}<span class="symptom-badge">Deseo de Orinar Durante</span>{% endif %}
                                                    {% if latest_ficha.vaginal_dryness %}<span class="symptom-badge">Resequedad</span>{% endif %}
                                                    {% if latest_ficha.impaired_by_incontinence %}<span class="symptom-badge">Perjudicado por Incontinencia</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.sexual_history_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.sexual_history_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- EXAMEN F√çSICO -->
                            {% if latest_ficha.diastasis or latest_ficha.scars or latest_ficha.adherences or latest_ficha.skin_coloration or latest_ficha.push_exam or latest_ficha.ncp_tone_contraction or latest_ficha.ncp_tone_relaxation or latest_ficha.ncp_tone_push or latest_ficha.ncp_tone_pain or latest_ficha.anal_cutaneous_reflex or latest_ficha.vulvo_cavernous_reflex or latest_ficha.cough_reflex or latest_ficha.physical_exam_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">üîç Examen F√≠sico</h4>
                                    <div class="subsection-content">
                                        <div class="detail-grid">
                                            {% if latest_ficha.push_exam %}
                                                <div class="detail-item">
                                                    <strong>Pujo:</strong>
                                                    <span>{{ latest_ficha.get_push_exam_display }}</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% if latest_ficha.diastasis %}
                                            <div class="detail-item full-width">
                                                <strong>Diastasis:</strong>
                                                <span>{{ latest_ficha.diastasis|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.scars %}
                                            <div class="detail-item full-width">
                                                <strong>Cicatrices:</strong>
                                                <span>{{ latest_ficha.scars|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.adherences %}
                                            <div class="detail-item full-width">
                                                <strong>Adherencias:</strong>
                                                <span>{{ latest_ficha.adherences|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.skin_coloration %}
                                            <div class="detail-item full-width">
                                                <strong>Coloraci√≥n de la Piel:</strong>
                                                <span>{{ latest_ficha.skin_coloration|linebreaks }}</span>
                                            </div>
                                        {% endif %}

                                        <!-- NCP Tono -->
                                        {% if latest_ficha.ncp_tone_contraction or latest_ficha.ncp_tone_relaxation or latest_ficha.ncp_tone_push or latest_ficha.ncp_tone_pain %}
                                            <div class="subsubsection">
                                                <h5>NCP - Tono</h5>
                                                {% if latest_ficha.ncp_tone_contraction %}
                                                    <div class="detail-item">
                                                        <strong>Contracci√≥n:</strong>
                                                        <span>{{ latest_ficha.ncp_tone_contraction|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                                {% if latest_ficha.ncp_tone_relaxation %}
                                                    <div class="detail-item">
                                                        <strong>Relajaci√≥n:</strong>
                                                        <span>{{ latest_ficha.ncp_tone_relaxation|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                                {% if latest_ficha.ncp_tone_push %}
                                                    <div class="detail-item">
                                                        <strong>Pujo:</strong>
                                                        <span>{{ latest_ficha.ncp_tone_push|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                                {% if latest_ficha.ncp_tone_pain %}
                                                    <div class="detail-item">
                                                        <strong>Dolor:</strong>
                                                        <span>{{ latest_ficha.ncp_tone_pain|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        <!-- Reflejos -->
                                        {% if latest_ficha.anal_cutaneous_reflex or latest_ficha.vulvo_cavernous_reflex or latest_ficha.cough_reflex %}
                                            <div class="symptoms-section">
                                                <strong>Sensibilidad y Reflejo (S2-S4):</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.anal_cutaneous_reflex == 'si' %}<span class="symptom-badge">Reflejo Cut√°neo Anal</span>{% endif %}
                                                    {% if latest_ficha.vulvo_cavernous_reflex == 'si' %}<span class="symptom-badge">Reflejo Vulvo Cavernoso</span>{% endif %}
                                                    {% if latest_ficha.cough_reflex == 'si' %}<span class="symptom-badge">Reflejo Tus√≠geno</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if latest_ficha.physical_exam_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.physical_exam_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- EXAMEN INTRACAVITARIO -->
                            {% if latest_ficha.intracavitary_consent or latest_ficha.intracavitary_scars or latest_ficha.intracavitary_mucosa or latest_ficha.mea_tonicity_rest or latest_ficha.mea_perception or latest_ficha.mea_contraction or latest_ficha.mea_pain_eva or latest_ficha.urethral_movement or latest_ficha.oxford_force or latest_ficha.intracavitary_exam_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">üî¨ Examen Intracavitario</h4>
                                    <div class="subsection-content">
                                        {% if latest_ficha.intracavitary_consent %}
                                            <div class="detail-item">
                                                <strong>Consentimiento:</strong>
                                                <span>S√≠</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.intracavitary_scars %}
                                            <div class="detail-item full-width">
                                                <strong>Cicatrices:</strong>
                                                <span>{{ latest_ficha.intracavitary_scars|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.intracavitary_mucosa %}
                                            <div class="detail-item full-width">
                                                <strong>Mucosa:</strong>
                                                <span>{{ latest_ficha.intracavitary_mucosa|linebreaks }}</span>
                                            </div>
                                        {% endif %}

                                        <!-- MEA -->
                                        {% if latest_ficha.mea_tonicity_rest or latest_ficha.mea_perception or latest_ficha.mea_contraction or latest_ficha.mea_symmetry_rest or latest_ficha.mea_symmetry_contraction or latest_ficha.mea_voluntary_relaxation %}
                                            <div class="subsubsection">
                                                <h5>MEA (M√∫sculos del Elevador del Ano)</h5>
                                                <div class="detail-grid">
                                                    {% if latest_ficha.mea_tonicity_rest %}
                                                        <div class="detail-item">
                                                            <strong>Tonicidad Reposo:</strong>
                                                            <span>{{ latest_ficha.mea_tonicity_rest }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.mea_perception %}
                                                        <div class="detail-item">
                                                            <strong>Percepci√≥n:</strong>
                                                            <span>{{ latest_ficha.mea_perception }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.mea_contraction %}
                                                        <div class="detail-item">
                                                            <strong>Contracci√≥n:</strong>
                                                            <span>{{ latest_ficha.mea_contraction }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.mea_voluntary_relaxation %}
                                                        <div class="detail-item">
                                                            <strong>Relajaci√≥n Voluntaria:</strong>
                                                            <span>{{ latest_ficha.mea_voluntary_relaxation }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        <!-- Dolor MEA -->
                                        {% if latest_ficha.mea_pain_eva or latest_ficha.mea_pain_location or latest_ficha.mea_pain_when or latest_ficha.mea_pain_description %}
                                            <div class="subsubsection">
                                                <h5>Dolor MEA</h5>
                                                <div class="detail-grid">
                                                    {% if latest_ficha.mea_pain_eva %}
                                                        <div class="detail-item">
                                                            <strong>EVA:</strong>
                                                            <span>{{ latest_ficha.mea_pain_eva }}/10</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.mea_pain_location %}
                                                        <div class="detail-item">
                                                            <strong>D√≥nde:</strong>
                                                            <span>{{ latest_ficha.mea_pain_location }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.mea_pain_when %}
                                                        <div class="detail-item">
                                                            <strong>Cu√°ndo:</strong>
                                                            <span>{{ latest_ficha.mea_pain_when }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                {% if latest_ficha.mea_pain_description %}
                                                    <div class="detail-item full-width">
                                                        <strong>Descripci√≥n:</strong>
                                                        <span>{{ latest_ficha.mea_pain_description|linebreaks }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}

                                        {% if latest_ficha.oxford_force %}
                                            <div class="detail-item full-width">
                                                <strong>Fuerza (Oxford):</strong>
                                                <span>{{ latest_ficha.oxford_force|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.intracavitary_exam_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.intracavitary_exam_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- EXAMEN COLOPROCTOL√ìGICO -->
                            {% if latest_ficha.coloproctologic_consent or latest_ficha.anal_canal_closure or latest_ficha.irritation or latest_ficha.stool_remains or latest_ficha.rectocele_exam or latest_ficha.coloproctologic_scars or latest_ficha.coloproctologic_hemorrhoids or latest_ficha.rest_tone or latest_ficha.resistance or latest_ficha.oxford_anorectal_angle or latest_ficha.anorectal_opening or latest_ficha.thoracic_rectal_synchronization or latest_ficha.anal_canal_relaxation or latest_ficha.coloproctologic_exam_other %}
                                <div class="ficha-subsection">
                                    <h4 class="subsection-title">ü©ª Examen Coloproctol√≥gico</h4>
                                    <div class="subsection-content">
                                        {% if latest_ficha.coloproctologic_consent %}
                                            <div class="detail-item">
                                                <strong>Consentimiento:</strong>
                                                <span>S√≠</span>
                                            </div>
                                        {% endif %}

                                        <!-- Observaciones -->
                                        {% if latest_ficha.anal_canal_closure or latest_ficha.irritation or latest_ficha.stool_remains or latest_ficha.rectocele_exam %}
                                            <div class="symptoms-section">
                                                <strong>Observaciones:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.anal_canal_closure %}<span class="symptom-badge">Cierre Canal Anal</span>{% endif %}
                                                    {% if latest_ficha.irritation %}<span class="symptom-badge">Irritaci√≥n</span>{% endif %}
                                                    {% if latest_ficha.stool_remains %}<span class="symptom-badge">Resto de Deposiciones</span>{% endif %}
                                                    {% if latest_ficha.rectocele_exam %}<span class="symptom-badge">Recto Cele</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if latest_ficha.coloproctologic_scars %}
                                            <div class="detail-item full-width">
                                                <strong>Cicatrices:</strong>
                                                <span>{{ latest_ficha.coloproctologic_scars|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                        {% if latest_ficha.coloproctologic_hemorrhoids %}
                                            <div class="detail-item full-width">
                                                <strong>Hemorroides:</strong>
                                                <span>{{ latest_ficha.coloproctologic_hemorrhoids|linebreaks }}</span>
                                            </div>
                                        {% endif %}

                                        <!-- Tono y resistencia -->
                                        {% if latest_ficha.rest_tone or latest_ficha.resistance or latest_ficha.eae_tonicity_rest or latest_ficha.eae_contraction %}
                                            <div class="subsubsection">
                                                <h5>Tono y Resistencia</h5>
                                                <div class="detail-grid">
                                                    {% if latest_ficha.rest_tone %}
                                                        <div class="detail-item">
                                                            <strong>Tono en Reposo:</strong>
                                                            <span>{{ latest_ficha.rest_tone }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.resistance %}
                                                        <div class="detail-item">
                                                            <strong>Resistencia:</strong>
                                                            <span>{{ latest_ficha.resistance }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.eae_tonicity_rest %}
                                                        <div class="detail-item">
                                                            <strong>Tonicidad EAE Reposo:</strong>
                                                            <span>{{ latest_ficha.eae_tonicity_rest }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if latest_ficha.eae_contraction %}
                                                        <div class="detail-item">
                                                            <strong>Contracci√≥n EAE:</strong>
                                                            <span>{{ latest_ficha.eae_contraction }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if latest_ficha.oxford_anorectal_angle %}
                                            <div class="detail-item full-width">
                                                <strong>√Ångulo Ano Rectal (Oxford):</strong>
                                                <span>{{ latest_ficha.oxford_anorectal_angle|linebreaks }}</span>
                                            </div>
                                        {% endif %}

                                        <!-- Empujo -->
                                        {% if latest_ficha.anorectal_opening or latest_ficha.thoracic_rectal_synchronization or latest_ficha.anal_canal_relaxation %}
                                            <div class="symptoms-section">
                                                <strong>Empujo:</strong>
                                                <div class="symptom-badges">
                                                    {% if latest_ficha.anorectal_opening %}<span class="symptom-badge">Apertura Ano Rectal</span>{% endif %}
                                                    {% if latest_ficha.thoracic_rectal_synchronization %}<span class="symptom-badge">Sincronizaci√≥n Toraco Rectal</span>{% endif %}
                                                    {% if latest_ficha.anal_canal_relaxation %}<span class="symptom-badge">Relajaci√≥n Canal Anal</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% if latest_ficha.coloproctologic_exam_other %}
                                            <div class="detail-item full-width">
                                                <strong>Otros:</strong>
                                                <span>{{ latest_ficha.coloproctologic_exam_other|linebreaks }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Botones de acci√≥n -->
                            <div class="ficha-actions">
                                <a href="{% url 'ficha_clinica_detail' patient.pk latest_ficha.pk %}" class="btn btn-info btn-sm">Ver Detalle Completo</a>
                                <a href="{% url 'ficha_clinica_update' patient.pk latest_ficha.pk %}" class="btn btn-primary btn-sm">Editar</a>
                                <a href="{% url 'ficha_clinica_list' patient.pk %}" class="btn btn-secondary btn-sm">Ver Todas</a>
                            </div>
                        {% else %}
                            <div class="no-ficha-message">
                                <p>Este paciente a√∫n no tiene fichas cl√≠nicas.</p>
                            </div>
                        {% endif %}
                        <div class="ficha-main-actions">
                            <a href="{% url 'ficha_clinica_create' patient.pk %}" class="btn btn-success">
                                {% if latest_ficha %}Nueva Ficha Cl√≠nica{% else %}Crear Primera Ficha Cl√≠nica{% endif %}
                            </a>
                        </div>
                    </div>
                </div>
                <!-- SECCI√ìN: ANTECEDENTES GINECOL√ìGICOS -->
                <div class="clinical-section">
                    <h3 class="section-title">ü©∫ Antecedentes Ginecol√≥gicos</h3>
            <div class="section-content">
                <div class="detail-grid">
                    {% if patient.menopause %}
                        <div class="detail-item">
                            <strong>Menopausia:</strong>
                            <span>{{ patient.get_menopause_display }}{% if patient.menopause_time %} ({{ patient.menopause_time }}){% endif %}</span>
                        </div>
                    {% endif %}

                    {% if patient.regular_menstrual_cycle %}
                        <div class="detail-item">
                            <strong>Ciclo Menstrual Regular:</strong>
                            <span>{{ patient.get_regular_menstrual_cycle_display }}</span>
                        </div>
                    {% endif %}

                    {% if patient.pregnancies_g %}
                        <div class="detail-item">
                            <strong>Gestaciones (G):</strong>
                            <span>{{ patient.pregnancies_g }}</span>
                        </div>
                    {% endif %}

                    {% if patient.abortions_a %}
                        <div class="detail-item">
                            <strong>Abortos (A):</strong>
                            <span>{{ patient.abortions_a }}</span>
                        </div>
                    {% endif %}

                    {% if patient.losses_p %}
                        <div class="detail-item">
                            <strong>P√©rdidas (P):</strong>
                            <span>{{ patient.losses_p }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.episiotomies %}
                        <div class="detail-item">
                            <strong>Episiotom√≠as:</strong>
                            <span>{{ patient.get_episiotomies_display }}</span>
                        </div>
                    {% endif %}
                    
                    {% if patient.prolapse %}
                        <div class="detail-item">
                            <strong>Prolapso:</strong>
                            <span>{{ patient.get_prolapse_display }}{% if patient.prolapse_type %} ({{ patient.prolapse_type }}){% endif %}</span>
                        </div>
                    {% endif %}
                </div>

                <!-- Indicadores ginecol√≥gicos -->
                {% if patient.io or patient.if_field or patient.ig %}
                    <div class="indicators-section">
                        <strong>Indicadores:</strong>
                        <div class="indicator-badges">
                            {% if patient.io %}<span class="indicator-badge">IO</span>{% endif %}
                            {% if patient.if_field %}<span class="indicator-badge">IF</span>{% endif %}
                            {% if patient.ig %}<span class="indicator-badge">IG</span>{% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if patient.allergies %}
                    <div class="detail-item full-width">
                        <strong>Alergias:</strong>
                        <span>{{ patient.allergies|linebreaks }}</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

        <!-- SIDEBAR: HISTORIAL DE CITAS -->
        <div class="sidebar">
            <div class="appointments-section">
                <div class="appointments-header">
                    <h3>üìÖ Historial de Evacuaci√≥n</h3>
                    <a href="{% url 'appointment_create' patient.pk %}" class="btn btn-primary btn-sm">Nueva Cita</a>
                </div>

                {% if appointments %}
                    <div class="appointments-list">
                        {% for appointment in appointments %}
                            <div class="appointment-card">
                                <div class="appointment-date">
                                    <strong>{{ appointment.date_time|date:"d/m/Y" }}</strong>
                                </div>
                                <div class="appointment-header">
                                    {% if appointment.session_description %}
                                        <div class="appointment-description">
                                            <strong>Descripci√≥n:</strong>
                                            <p>{{ appointment.session_description }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="appointment-content">
                                    <div class="appointment-tasks-and-tests">
                                        {% if appointment.tasks %}
                                            <div class="appointment-tasks">
                                                <strong>Tareas:</strong>
                                                <p>{{ appointment.tasks|linebreaks }}</p>
                                            </div>
                                        {% endif %}

                                        <!-- Test PERFECT -->
                                        {% if appointment.perfect_p_power or appointment.perfect_e_endurance or appointment.perfect_r_repetitions or appointment.perfect_f_fast or appointment.perfect_e_every or appointment.perfect_c_cocontraction or appointment.perfect_t_timing %}
                                            <div class="test-perfect">
                                                <strong>Test PERFECT:</strong>
                                                <div class="perfect-scores">
                                                    {% if appointment.perfect_p_power %}<span class="score">P: {{ appointment.perfect_p_power }}</span>{% endif %}
                                                    {% if appointment.perfect_e_endurance %}<span class="score">E: {{ appointment.perfect_e_endurance }}</span>{% endif %}
                                                    {% if appointment.perfect_r_repetitions %}<span class="score">R: {{ appointment.perfect_r_repetitions }}</span>{% endif %}
                                                    {% if appointment.perfect_f_fast %}<span class="score">F: {{ appointment.perfect_f_fast }}</span>{% endif %}
                                                    {% if appointment.perfect_e_every %}<span class="score">E: {{ appointment.get_perfect_e_every_display }}</span>{% endif %}
                                                    {% if appointment.perfect_c_cocontraction %}<span class="score">C: {{ appointment.get_perfect_c_cocontraction_display }}</span>{% endif %}
                                                    {% if appointment.perfect_t_timing %}<span class="score">T: {{ appointment.get_perfect_t_timing_display }}</span>{% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Test del Bal√≥n -->
                                    {% if appointment.balloon_rectal_sensation or appointment.balloon_first_desire_volume or appointment.balloon_normal_desire_volume or appointment.balloon_max_tolerable_capacity or appointment.balloon_rectoanal_reflex or appointment.balloon_expulsion %}
                                        <div class="test-balloon">
                                            <strong>Test del Bal√≥n:</strong>
                                            <div class="balloon-results">
                                                {% if appointment.balloon_rectal_sensation %}<div class="balloon-item"><small>Sensaci√≥n rectal:</small> {{ appointment.balloon_rectal_sensation }}</div>{% endif %}
                                                {% if appointment.balloon_first_desire_volume %}<div class="balloon-item"><small>Primer deseo:</small> {{ appointment.balloon_first_desire_volume }}</div>{% endif %}
                                                {% if appointment.balloon_normal_desire_volume %}<div class="balloon-item"><small>Deseo normal:</small> {{ appointment.balloon_normal_desire_volume }}</div>{% endif %}
                                                {% if appointment.balloon_max_tolerable_capacity %}<div class="balloon-item"><small>Capacidad m√°x:</small> {{ appointment.balloon_max_tolerable_capacity }}</div>{% endif %}
                                                {% if appointment.balloon_rectoanal_reflex %}<div class="balloon-item"><small>Reflejo rectoanal:</small> {{ appointment.get_balloon_rectoanal_reflex_display }}</div>{% endif %}
                                                {% if appointment.balloon_expulsion %}<div class="balloon-item"><small>Expulsi√≥n:</small> {{ appointment.get_balloon_expulsion_display }}</div>{% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    {% if appointment.additional_notes %}
                                        <div class="appointment-notes">
                                            <strong>Notas Adicionales:</strong>
                                            <p>{{ appointment.additional_notes|linebreaks }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="appointment-actions">
                                    <a href="{% url 'appointment_update' appointment.pk %}" class="btn btn-sm btn-primary">Editar</a>
                                    <a href="{% url 'appointment_delete' appointment.pk %}" class="btn btn-sm btn-danger">Eliminar</a>
                                    <small class="text-muted">{{ appointment.created_at|date:"d/m/Y H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-appointments">
                        <p>No hay citas registradas.</p>
                        <a href="{% url 'appointment_create' patient.pk %}" class="btn btn-primary btn-sm">Primera Cita</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}